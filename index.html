<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>AI æ‰‹åŠ¿ç²’å­ (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
      font-family: 'Segoe UI', sans-serif;
    }

    canvas {
      display: block;
    }

    #input-video {
      display: none;
    }

    /* UI å®¹å™¨ */
    #ui-container {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      padding: 15px;
      border-radius: 10px;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
    }

    .control-group {
      margin-bottom: 10px;
    }

    label {
      display: inline-block;
      width: 80px;
      font-size: 14px;
    }

    select,
    input[type=color] {
      background: #333;
      border: 1px solid #555;
      color: white;
      padding: 4px;
      border-radius: 4px;
    }

    /* å¯åŠ¨è¦†ç›–å±‚ */
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 100;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      transition: opacity 0.5s;
    }

    button#start-btn {
      background: linear-gradient(90deg, #00C9FF 0%, #92FE9D 100%);
      border: none;
      padding: 15px 50px;
      color: #000;
      font-weight: bold;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 0 20px rgba(0, 201, 255, 0.5);
      transition: transform 0.2s;
    }

    button#start-btn:hover {
      transform: scale(1.05);
    }

    button#start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #status {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #0f0;
      font-weight: bold;
      display: none;
    }

    .error {
      color: #ff4444;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>

<body>

  <div id="ui-container" style="display:none;">
    <div class="control-group">
      <label>å½¢çŠ¶:</label>
      <select id="shape-select">
        <option value="Heart">â¤ï¸ çˆ±å¿ƒ</option>
        <option value="Saturn">ğŸª åœŸæ˜Ÿ</option>
        <option value="Flower">ğŸŒ¸ èŠ±æœµ</option>
        <option value="Fireworks">ğŸ† çƒŸèŠ±</option>
      </select>
    </div>
    <div class="control-group">
      <label>é¢œè‰²:</label>
      <input type="color" id="color-picker" value="#00ffff">
    </div>
    <div style="font-size:12px; opacity:0.7; margin-top:5px;">
      æç¤º: æåˆæ‰‹æŒ‡èšæ‹¢ï¼Œå¼ å¼€æ‰©æ•£
    </div>
  </div>

  <div id="overlay">
    <h1>âœ¨ AI æ‰‹åŠ¿ç²’å­ç³»ç»Ÿ</h1>
    <div id="msg">å‡†å¤‡å°±ç»ªï¼Œè¯·ç‚¹å‡»å¼€å§‹</div>
    <button id="start-btn">å¼€å¯æ‘„åƒå¤´</button>
    <div id="error-log" class="error"></div>
  </div>

  <div id="status">âœ‹ å·²æ£€æµ‹åˆ°æ‰‹åŠ¿</div>
  <video id="input-video"></video>

  <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- å…¨å±€å˜é‡ ---
    const CONFIG = { particleCount: 12000, handInfluence: 0 };
    let scene, camera, renderer, particles, geometry, material;
    let targetPositions = [], currentPositions = [];
    let time = 0;

    // --- ç¯å¢ƒæ£€æŸ¥ ---
    if (location.protocol === 'file:') {
      document.getElementById('error-log').innerHTML = "âš ï¸ é”™è¯¯ï¼šè¯·å‹¿ç›´æ¥åŒå‡»æ‰“å¼€ HTML<br>è¯·ä½¿ç”¨ VS Code Live Server è¿è¡Œ";
      document.getElementById('start-btn').disabled = true;
    }

    // --- Three.js åˆå§‹åŒ– ---
    function initThree() {
      scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x000000, 0.02);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.z = 8;
      camera.position.y = 1;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      document.body.appendChild(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 1.0;

      // ç²’å­ç³»ç»Ÿ
      const posArray = new Float32Array(CONFIG.particleCount * 3);
      targetPositions = new Float32Array(CONFIG.particleCount * 3);

      for (let i = 0; i < CONFIG.particleCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 15;
      }

      geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

      const sprite = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png');
      material = new THREE.PointsMaterial({
        color: 0x00ffff, size: 0.08, map: sprite,
        blending: THREE.AdditiveBlending, depthWrite: false, transparent: true
      });

      particles = new THREE.Points(geometry, material);
      scene.add(particles);

      generateShape('Heart'); // é»˜è®¤å½¢çŠ¶

      // ç»‘å®šç®€æ˜“ UI äº‹ä»¶
      document.getElementById('ui-container').style.display = 'block';
      document.getElementById('shape-select').addEventListener('change', (e) => generateShape(e.target.value));
      document.getElementById('color-picker').addEventListener('input', (e) => material.color.set(e.target.value));

      animate();
    }

    // --- å½¢çŠ¶ç”Ÿæˆå™¨ ---
    function generateShape(type) {
      const count = CONFIG.particleCount;
      for (let i = 0; i < count; i++) {
        const i3 = i * 3;
        let x = 0, y = 0, z = 0;

        if (type === 'Heart') {
          const t = Math.random() * Math.PI * 2, u = Math.random() * Math.PI;
          x = 16 * Math.pow(Math.sin(t), 3) * Math.sin(u);
          y = (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t)) * Math.sin(u);
          z = 6 * Math.cos(u); x *= 0.2; y *= 0.2; z *= 0.2;
        }
        else if (type === 'Saturn') {
          const isRing = Math.random() > 0.4;
          if (isRing) { const a = Math.random() * 6.28, r = 3 + Math.random() * 2.5; x = Math.cos(a) * r; z = Math.sin(a) * r; y = (Math.random() - 0.5) * 0.2; }
          else { const phi = Math.acos(-1 + (2 * i) / (count * 0.4)), th = Math.sqrt(count * 0.4 * Math.PI) * phi; x = 1.5 * Math.cos(th) * Math.sin(phi); y = 1.5 * Math.sin(th) * Math.sin(phi); z = 1.5 * Math.cos(phi); }
        }
        else if (type === 'Flower') {
          const u = Math.random() * 6.28, v = Math.random() * 3.14, r = 2 + Math.sin(5 * u) * Math.sin(5 * v);
          x = r * Math.sin(v) * Math.cos(u); y = r * Math.sin(v) * Math.sin(u); z = r * Math.cos(v);
        }
        else { // Fireworks
          const theta = Math.random() * 6.28, phi = Math.acos(2 * Math.random() - 1), r = 4 * Math.cbrt(Math.random());
          x = r * Math.sin(phi) * Math.cos(theta); y = r * Math.sin(phi) * Math.sin(theta); z = r * Math.cos(phi);
        }
        targetPositions[i3] = x; targetPositions[i3 + 1] = y; targetPositions[i3 + 2] = z;
      }
    }

    // --- åŠ¨ç”»å¾ªç¯ ---
    function animate() {
      requestAnimationFrame(animate);
      time += 0.01;

      const positions = geometry.attributes.position.array;
      // å‘¼å¸æ•ˆæœ + æ‰‹åŠ¿å½±å“
      const baseScale = 1.0;
      const explosion = CONFIG.handInfluence * 4.0;

      for (let i = 0; i < CONFIG.particleCount; i++) {
        const i3 = i * 3;
        const tx = targetPositions[i3];
        const ty = targetPositions[i3 + 1];
        const tz = targetPositions[i3 + 2];

        // è®¡ç®—æ–¹å‘å‘é‡ (å½’ä¸€åŒ–)
        const d = Math.sqrt(tx * tx + ty * ty + tz * tz) || 0.01;
        const nx = tx / d, ny = ty / d, nz = tz / d;

        // ç›®æ ‡ä½ç½® = åŸå§‹ä½ç½® + (æ³•çº¿æ–¹å‘ * æ‰‹åŠ¿å¼ºåº¦)
        const targetX = tx + nx * explosion;
        const targetY = ty + ny * explosion;
        const targetZ = tz + nz * explosion;

        // ç¼“åŠ¨
        positions[i3] += (targetX - positions[i3]) * 0.1;
        positions[i3 + 1] += (targetY - positions[i3 + 1]) * 0.1;
        positions[i3 + 2] += (targetZ - positions[i3 + 2]) * 0.1;
      }

      geometry.attributes.position.needsUpdate = true;
      particles.rotation.y += 0.003;
      renderer.render(scene, camera);
    }

    // --- MediaPipe é€»è¾‘ ---
    async function startCamera() {
      const btn = document.getElementById('start-btn');
      const msg = document.getElementById('msg');
      btn.style.display = 'none';
      msg.innerText = "æ­£åœ¨åŠ è½½ AI æ¨¡å‹... (è¯·ç¨å€™)";

      initThree(); // åˆå§‹åŒ– 3D

      try {
        // æ³¨æ„ï¼šè¿™é‡Œç›´æ¥ä½¿ç”¨å…¨å±€ window.Hands å’Œ window.Camera
        // ä¸å†ä½¿ç”¨ import { Camera } ...

        const hands = new window.Hands({
          locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
          }
        });

        hands.setOptions({
          maxNumHands: 1,
          modelComplexity: 1,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
          const status = document.getElementById('status');
          if (results.multiHandLandmarks.length > 0) {
            status.style.display = 'block';
            const lm = results.multiHandLandmarks[0];

            // è®¡ç®—æŒ‡å°–è·ç¦» (Landmark 4 å’Œ 8)
            const dist = Math.sqrt(
              Math.pow(lm[4].x - lm[8].x, 2) +
              Math.pow(lm[4].y - lm[8].y, 2) +
              Math.pow(lm[4].z - lm[8].z, 2)
            );

            // æ˜ å°„é€»è¾‘: è·ç¦» 0.02(é—­åˆ) -> 0.2(å¼ å¼€)
            let val = (dist - 0.02) * 5;
            val = Math.max(0, Math.min(1, val)); // é™åˆ¶åœ¨ 0~1

            // å¹³æ»‘èµ‹å€¼
            CONFIG.handInfluence += (val - CONFIG.handInfluence) * 0.1;
          } else {
            status.style.display = 'none';
            // æ²¡æ‰‹æ—¶æ…¢æ…¢å½’é›¶
            CONFIG.handInfluence += (0 - CONFIG.handInfluence) * 0.05;
          }
        });

        const videoElement = document.getElementById('input-video');
        const cameraUtils = new window.Camera(videoElement, {
          onFrame: async () => { await hands.send({ image: videoElement }); },
          width: 640, height: 480
        });

        await cameraUtils.start();

        // æˆåŠŸ
        const overlay = document.getElementById('overlay');
        overlay.style.opacity = 0;
        setTimeout(() => overlay.remove(), 500);

      } catch (err) {
        console.error(err);
        document.getElementById('error-log').innerText = "åŠ è½½å¤±è´¥: " + err.message;
        msg.innerText = "è¯·æ£€æŸ¥ F12 æ§åˆ¶å°æŠ¥é”™";
      }
    }

    document.getElementById('start-btn').addEventListener('click', startCamera);

    // çª—å£é€‚é…
    window.addEventListener('resize', () => {
      if (camera && renderer) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });
  </script>
</body>

</html>